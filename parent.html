<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Parent Dashboard</title>
  <link rel="stylesheet" href="assets/app.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/supabaseClient.js"></script>
  <script src="assets/api.js"></script>
</head>
<body>
<header style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
  <h1>Parent Dashboard</h1>
  <div id="auth"></div>
</header>

<main id="content" class="card">
  <section id="controls" style="display:none;">
    <label for="student">Select Student:</label>
    <select id="student"></select>

    <div id="summary" style="margin-top:1rem;"></div>
    <div id="details" style="margin-top:2rem;"></div>

    <button onclick="window.location.href='index.html'" style="margin-top:2rem;">⬅ Back to Dashboard</button>
  </section>
</main>

<script>
(async () => {
  const authEl = document.getElementById("auth");
  const controls = document.getElementById("controls");
  const studentSel = document.getElementById("student");
  const summaryEl = document.getElementById("summary");
  const detailsEl = document.getElementById("details");

  const ctx = await sb.currentUserWithProfile();
  if (!ctx) {
    authEl.innerHTML = `
      <input id="email" type="text" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button id="login">Login</button>
    `;
    const doLogin = async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if (!email || !password) { alert("Enter both email and password"); return; }
      const user = await api.signInWithPassword(email, password);
      if (user) location.reload();
    };
    document.getElementById("login").onclick = doLogin;
    return;
  } else {
    authEl.innerHTML = `<span>${ctx.profile?.display_name ?? "Parent"}</span>
                        <button id="logout">Sign out</button>`;
    document.getElementById("logout").onclick = api.signOut;
    controls.style.display = "block";
  }

  const { data: students } = await sb.supabase.from("profiles").select("user_id, display_name").eq("role", "student");
  studentSel.innerHTML = students.map(s => `<option value="${s.user_id}">${s.display_name}</option>`).join("");

  async function listFiles(folder) {
    const names = new Set();
    let page = 0, pageSize = 100;
    while (true) {
      const { data, error } = await sb.supabase
        .storage.from("content")
        .list(folder, { limit: pageSize, offset: page*pageSize });
      if (error) break;
      (data || []).forEach(f => names.add(f.name));
      if (!data || data.length < pageSize) break;
      page++;
    }
    return names;
  }

  async function filterItemsByStorage(items, folder) {
    const names = await listFiles(folder);
    return items.filter(i => {
      const mdName = i.md_path?.split("/").pop();
      const qzName = i.quiz_path?.split("/").pop();
      return names.has(mdName) && names.has(qzName);
    });
  }

  async function loadSummary(studentId, displayName) {
    let { data: lessons } = await sb.supabase.from("lesson_with_attempts").select("*").eq("user_id", studentId);
    let { data: tests }   = await sb.supabase.from("tests_with_attempts").select("*").eq("user_id", studentId);

    lessons = await filterItemsByStorage(lessons || [], `${displayName}/lessons`);
    tests   = await filterItemsByStorage(tests || [], `${displayName}/tests`);

    const completedLessons = lessons.filter(l => l.score != null);
    const remainingLessons = lessons.filter(l => l.score == null);

    const completedTests = tests.filter(t => t.score != null);
    const remainingTests = tests.filter(t => t.score == null);

    summaryEl.innerHTML = `
      <h3>Summary</h3>
      <p><strong>Lessons:</strong> ${completedLessons.length} / ${lessons.length} completed (${remainingLessons.length} remaining)</p>
      <p><strong>Tests:</strong> ${completedTests.length} / ${tests.length} completed (${remainingTests.length} remaining)</p>
    `;

    detailsEl.innerHTML = `
      <h3>Remaining Lessons</h3>
      ${remainingLessons.length > 0 ? `<ul>${remainingLessons.map(l => `<li>${l.title} — <span class="muted">Incomplete</span></li>`).join("")}</ul>` : `<p class="muted">All lessons completed ✅</p>`}

      <h3>Completed Lessons</h3>
      ${completedLessons.length > 0 ? `<ul>${completedLessons.map(l => `<li>${l.title} — <strong>${l.score}%</strong></li>`).join("")}</ul>` : `<p class="muted">No lessons completed yet.</p>`}

      <h3>Remaining Tests</h3>
      ${remainingTests.length > 0 ? `<ul>${remainingTests.map(t => `<li>${t.title} — <span class="muted">Incomplete</span></li>`).join("")}</ul>` : `<p class="muted">All tests completed ✅</p>`}

      <h3>Completed Tests</h3>
      ${completedTests.length > 0 ? `<ul>${completedTests.map(t => `<li>${t.title} — <strong>${t.score}%</strong></li>`).join("")}</ul>` : `<p class="muted">No tests completed yet.</p>`}
    `;
  }

  if (students.length > 0) {
    await loadSummary(students[0].user_id, students[0].display_name);
  }
  studentSel.onchange = async () => {
    const selected = students.find(s => s.user_id === studentSel.value);
    await loadSummary(studentSel.value, selected.display_name);
  };
})();
</script>
</body>
</html>
