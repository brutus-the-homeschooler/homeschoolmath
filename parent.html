<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Parent Dashboard</title>
  <link rel="stylesheet" href="assets/app.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/supabaseClient.js"></script>
  <script src="assets/api.js"></script>
</head>
<body>
<header>
  <h1>Parent Dashboard</h1>
  <div id="auth"></div>
</header>

<main id="content" class="card">
  <section id="controls" style="display:none;">
    <label for="student">Select Student:</label>
    <select id="student"></select>

    <div id="summary" style="margin-top:1rem;"></div>
  </section>
</main>

<script>
(async () => {
  const authEl = document.getElementById("auth");
  const controls = document.getElementById("controls");
  const studentSel = document.getElementById("student");
  const summaryEl = document.getElementById("summary");

  // --- Auth ---
  const ctx = await sb.currentUserWithProfile();
  if (!ctx) {
    authEl.innerHTML = `
      <input id="email" type="text" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button id="login">Login</button>
    `;
    const doLogin = async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if (!email || !password) { alert("Enter both email and password"); return; }
      const user = await api.signInWithPassword(email, password);
      if (user) location.reload();
    };
    document.getElementById("login").onclick = doLogin;
    return;
  } else {
    authEl.innerHTML = `<span>${ctx.profile?.display_name ?? "Parent"}</span>
                        <button id="logout">Sign out</button>`;
    document.getElementById("logout").onclick = api.signOut;
    controls.style.display = "block";
  }

  // --- Load students ---
  const { data: students, error: stuErr } = await sb.supabase
    .from("profiles")
    .select("id, display_name")
    .eq("role", "student");

  if (stuErr) {
    summaryEl.innerHTML = `<p class="muted">Error loading students: ${stuErr.message}</p>`;
    return;
  }

  studentSel.innerHTML = students.map(s => 
    `<option value="${s.id}">${s.display_name}</option>`).join("");

  // --- Load summary for selected student ---
  async function loadSummary(studentId) {
    // Lessons
    const { data: lessons } = await sb.supabase
      .from("lessons")
      .select("id, title");
    const { data: lAttempts } = await sb.supabase
      .from("attempts")
      .select("mapping_id, score")
      .eq("user_id", studentId);

    const lessonIds = new Set(lessons.map(l => l.id));
    const completedLessons = lAttempts.filter(a => lessonIds.has(a.mapping_id)).length;
    const totalLessons = lessons.length;

    // Tests
    const { data: tests } = await sb.supabase
      .from("tests")
      .select("id, title");
    const testIds = new Set(tests.map(t => t.id));
    const completedTests = lAttempts.filter(a => testIds.has(a.mapping_id)).length;
    const totalTests = tests.length;

    // Render summary
    summaryEl.innerHTML = `
      <h3>Summary</h3>
      <p><strong>Lessons:</strong> ${completedLessons} / ${totalLessons} completed (${totalLessons - completedLessons} remaining)</p>
      <p><strong>Tests:</strong> ${completedTests} / ${totalTests} completed (${totalTests - completedTests} remaining)</p>
    `;
  }

  // Load first student by default
  if (students.length > 0) {
    await loadSummary(students[0].id);
  }

  // Change student
  studentSel.onchange = async () => {
    await loadSummary(studentSel.value);
  };
})();
</script>
</body>
</html>
