<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Math — Lesson</title>
  <link rel="stylesheet" href="assets/app.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/supabaseClient.js"></script>
  <script src="assets/api.js"></script>

  <!-- MathJax config + loader -->
  <script>
    window.MathJax = {
       tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['\\[', '\\]']],   
  },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<header>
  <h1>Math — Lesson</h1>
  <div id="auth"></div>
</header>

<main id="content" class="card">
  <h2 id="lesson-title"></h2>
  <div id="markdown">Loading lesson…</div>
  <form id="quiz"></form>
  <button id="submit" class="primary">Submit Lesson</button>
  <div id="result"></div>
  <!-- Back button -->
  <button onclick="window.location.href='index.html'" style="margin-top:1rem;">⬅ Back to Dashboard</button>
</main>

<script>
(async () => {
  const authEl = document.getElementById("auth");
  const ctx = await sb.currentUserWithProfile();
  if (!ctx) {
    authEl.innerHTML = "Please log in.";
    return;
  } else {
    authEl.innerHTML = `<span>${ctx.profile?.display_name ?? "User"}</span>
                        <button id="logout">Sign out</button>`;
    document.getElementById("logout").onclick = api.signOut;
  }
  const userId = ctx.user.id;

  const urlParams = new URLSearchParams(window.location.search);
  const slug = urlParams.get("slug");

  // 1. Fetch lesson row
  const { data: lesson, error } = await sb.supabase
    .from("lesson_with_attempts")
    .select("*")
    .eq("slug", slug)
    .maybeSingle();

  if (error || !lesson) {
    document.getElementById("content").innerHTML = "<p>Lesson not found.</p>";
    return;
  }

  document.getElementById("lesson-title").textContent = lesson.title;

  // 2. Fetch markdown + quiz
  try {
    const md = await api.fetchSignedText(lesson.md_path);
    const quiz = JSON.parse(await api.fetchSignedText(lesson.quiz_path));

    // Render markdown body
    document.getElementById("markdown").innerHTML = marked.parse(md);
    if (window.MathJax) {
      MathJax.typesetPromise();
    }

    // Render quiz
    const quizEl = document.getElementById("quiz");
    quiz.questions.forEach(q => {
      const div = document.createElement("div");
      div.className = "question";
      // Prompt goes through marked so it can use LaTeX + Markdown
      div.innerHTML = `<p>${marked.parseInline(q.prompt)}</p>`;
      if (q.type === "input") {
        div.innerHTML += `<input type="text" data-id="${q.id}">`;
      } else if (q.type === "mcq") {
        q.choices.forEach((c, i) => {
          // Choices go through marked too
          div.innerHTML += `<label><input type="radio" name="${q.id}" value="${i}"> ${marked.parseInline(c)}</label><br>`;
        });
      }
      quizEl.appendChild(div);
    });

    // Re-typeset math in quiz prompts and choices
    if (window.MathJax) {
      MathJax.typesetPromise();
    }

    // 3. Handle submit
    document.getElementById("submit").onclick = async (e) => {
      e.preventDefault();
      let correct = 0;
      quiz.questions.forEach(q => {
        if (q.type === "input") {
          const val = document.querySelector(`input[data-id="${q.id}"]`).value.trim();
          // Support both q.answer and q.correctAnswer for flexibility
          if (val == q.answer || val == q.correctAnswer) correct++;
        } else if (q.type === "mcq") {
          const checked = document.querySelector(`input[name="${q.id}"]:checked`);
          if (checked && parseInt(checked.value) === q.answerIndex) correct++;
        }
      });
      const score = Math.round((correct / quiz.questions.length) * 100);
      document.getElementById("result").innerHTML = `<p>Score: ${score}%</p>`;

      // 4. Save attempt
      const { error: saveErr } = await sb.supabase
        .from("attempts")
        .upsert({
          user_id: userId,
          mapping_id: lesson.id,
          score
        }, { onConflict: "user_id,mapping_id" });

      if (saveErr) {
        console.error(saveErr);
        alert("Error saving attempt: " + saveErr.message);
      }
    };
  } catch (err) {
    console.error("Error loading lesson files:", err);
    document.getElementById("markdown").innerHTML = "<p>Error loading lesson content.</p>";
  }
})();
</script>
</body>
</html>
