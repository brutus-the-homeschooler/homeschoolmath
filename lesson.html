<!doctype html>
<html lang="en">
<head>
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Math ‚Äî Lesson</title>
  <link rel="stylesheet" href="assets/app.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="assets/supabaseClient.js"></script>
  <script src="assets/api.js"></script>
  <script src="assets/lesson-inputs.js"></script>
</head>
<body>
<header>
  <h1 id="lesson-title">Loading Lesson‚Ä¶</h1>
  <nav>
  <a href="index.html" class="button secondary">‚¨Ö Back to Lesson Page</a>
</nav>

  <div id="auth"></div>
</header>
<main class="card">
  <div id="lesson-content" data-lesson-id="">Loading‚Ä¶</div>
  <form id="quiz-form"></form>
  <button id="submit" class="primary">Submit Quiz</button>
  <div id="results"></div>
</main>

<script>
(async () => {
  const urlParams = new URLSearchParams(window.location.search);
  const slug = urlParams.get('slug');

  // get current user + profile
  const ctx = await sb.currentUserWithProfile();
  if (!ctx) {
    document.getElementById("lesson-content").textContent = "You must be signed in.";
    return;
  }

  // fetch lesson by slug
 // Fetch all lessons from DB
  const lessonsRaw = await api.listAllLessonsForSite();

// Check existence of files
  const lessons = [];
  for (const L of lessonsRaw) {
    const ok = await api.checkLessonFilesExist(L);
    if (ok) lessons.push(L);
  }

// Now lessons only contains those with valid .md and .json

  document.getElementById("lesson-title").textContent = lesson.title;
  

  // fetch markdown + quiz JSON from storage
  const lessonText = await api.fetchSignedText(lesson.md_path);
  const quizJson = JSON.parse(await api.fetchSignedText(lesson.quiz_path));


  // render lesson
  // render lesson
  const lessonEl = document.getElementById("lesson-content");
  lessonEl.dataset.lessonId = lesson.id || lesson.slug || ""; // use whatever identifier you prefer
  lessonEl.innerHTML = marked.parse(lessonText);

// attach autosave inputs (localStorage + optional Supabase)
  let userId = ctx.user?.id; // since you already got ctx at the top
  window.attachLessonInputs({ lessonId: lessonEl.dataset.lessonId, userId });


  // render quiz
  const quizForm = document.getElementById("quiz-form");
  quizForm.innerHTML = quizJson.questions.map((q, idx) => {
    let imageHtml = q.image ? `<div><img src="${q.image}" alt="Question image" style="max-width:200px; margin:8px 0;"></div>` : "";
  
    if (q.type === "mcq") {
      return `
        <fieldset>
          <legend>${idx+1}. ${q.prompt}</legend>
          ${imageHtml}
          ${q.choices.map((choice, i) => `
            <label>
              <input type="radio" name="${q.id}" value="${i}">
              ${choice}
            </label><br>
          `).join('')}
        </fieldset>
      `;
    } else if (q.type === "input") {
      return `
        <fieldset>
          <legend>${idx+1}. ${q.prompt}</legend>
          ${imageHtml}
          <input type="text" name="${q.id}" placeholder="Type your answer">
        </fieldset>
      `;
    }
  }).join("");


  // handle submission
  document.getElementById("submit").onclick = async (e) => {
    e.preventDefault();
    let score = 0;
    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "";

  quizJson.questions.forEach((q, idx) => {
    let correct = false;
    if (q.type === "mcq") {
      const selected = document.querySelector(`input[name="${q.id}"]:checked`);
      if (selected && parseInt(selected.value) === q.answerIndex) correct = true;
    } else if (q.type === "input") {
      const entered = document.querySelector(`input[name="${q.id}"]`).value.trim();
      if (entered.toLowerCase() === q.correctAnswer.toLowerCase()) correct = true;
    }

    if (correct) score += 1;
    resultsDiv.innerHTML += `<p>${idx+1}. ${q.prompt}<br>
      ${correct ? "‚úÖ Correct" : "‚ùå Incorrect"}<br>
      <em>${q.explain}</em></p>`;
  });

  const percent = Math.round((score / quizJson.questions.length) * 100);
  resultsDiv.innerHTML = `<h3>You scored ${score} / ${quizJson.questions.length} (${percent}%)</h3>` + resultsDiv.innerHTML;

  // record attempt in Supabase
  await api.recordAttempt(lesson.id, ctx.user.id, percent);

  // üîπ hide Submit button
  document.getElementById("submit").style.display = "none";

  // üîπ show retake message
  resultsDiv.innerHTML += `
    <div id="retake-box" style="margin-top:1em;">
      <button id="retake-btn" class="secondary">Send retake message</button>
    </div>
  `;

  document.getElementById("retake-btn").onclick = () => {
    alert("Retake request sent! (parent dashboard will handle approval)");
  };
};

})();
</script>
</body>
</html>
