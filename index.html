<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Math — Dashboard</title>
  <link rel="stylesheet" href="assets/app.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/supabaseClient.js"></script>
  <script src="assets/api.js"></script>
</head>
<body>
<header style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
  <h1>Math — Dashboard</h1>
  <div id="auth"></div>
</header>

<main id="content" class="card">
  <h2>Lessons</h2>
  <ul id="lessons">Loading…</ul>

  <h2>Tests</h2>
  <ul id="tests">Loading…</ul>
</main>

<p class="muted">Parent? Visit <a href="parent.html">Parent dashboard</a>.</p>

<script>
(async () => {
  const authEl = document.getElementById('auth');
  const lessonsEl = document.getElementById('lessons');
  const testsEl = document.getElementById('tests');

  // ----- Auth -----
  const ctx = await sb.currentUserWithProfile();
  if (!ctx) {
    authEl.innerHTML = `Please log in`;
    return;
  } else {
    authEl.innerHTML = `<span>${ctx.profile?.display_name ?? 'User'}</span>
                        <button id="logout">Sign out</button>`;
    document.getElementById('logout').onclick = api.signOut;
  }

  const userId = ctx.user.id;

  // ----- Lessons -----
  const lessons = await api.listLessonsAssignedToCurrentUser();
  if (!lessons.length) {
    lessonsEl.innerHTML = '<li>No lessons found.</li>';
  } else {
    lessonsEl.innerHTML = lessons.map(L => `
      <li>
        <a href="lesson.html?slug=${encodeURIComponent(L.slug)}">${L.title}</a>
        <small class="muted"> — for ${L.for_user}</small>
      </li>
    `).join('');
  }

  // ----- Tests -----
  const tests = await api.listTestsAssignedToCurrentUser();
  if (!tests.length) {
    testsEl.innerHTML = '<li>No tests found.</li>';
  } else {
    testsEl.innerHTML = tests.map(T => `
      <li>
        <a href="test.html?slug=${encodeURIComponent(T.slug)}">${T.title}</a>
        <small class="muted"> — for ${T.for_user}</small>
      </li>
    `).join('');
  }
})();
</script>
</body>
</html>
