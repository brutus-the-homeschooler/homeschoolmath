<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Math — Dashboard</title>
  <link rel="stylesheet" href="assets/app.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/supabaseClient.js"></script>
  <script src="assets/api.js"></script>
</head>
<body>
<header style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
  <h1>Math — Dashboard</h1>

  <div style="display:flex;align-items:center;gap:.5rem;">
    <label for="lesson-filter">Show:</label>
    <select id="lesson-filter">
      <option value="all">All</option>
      <option value="completed">Completed only</option>
      <option value="pending">Not completed only</option>
    </select>
  </div>

  <div id="auth"></div>
</header>

<main id="content" class="card">
  <h2>Progress</h2>
  <div id="progress-summary" class="muted">Loading progress…</div>

  <h2>Lessons</h2>
  <ul id="lessons">Loading…</ul>

  <h2>Tests</h2>
  <ul id="tests">Loading…</ul>
</main>

<p class="muted">Parent? Visit <a href="parent.html">Parent dashboard</a>.</p>

<script>
(async () => {
  const authEl    = document.getElementById("auth");
  const lessonsEl = document.getElementById("lessons");
  const testsEl   = document.getElementById("tests");
  const filterEl  = document.getElementById("lesson-filter");
  const progressEl = document.getElementById("progress-summary");

  // ----- Auth -----
  const ctx = await sb.currentUserWithProfile();
  if (!ctx) {
    authEl.innerHTML = `
      <input id="email" type="text" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button id="login">Login</button>
    `;
    const doLogin = async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if (!email || !password) { alert("Enter both email and password"); return; }
      const user = await api.signInWithPassword(email, password);
      if (user) location.reload();
    };
    document.getElementById("login").onclick = doLogin;
    document.getElementById("password").addEventListener("keydown", e => { if (e.key === "Enter") doLogin(); });
    lessonsEl.innerHTML = "<li>Sign in to view lessons.</li>";
    testsEl.innerHTML   = "<li>Sign in to view tests.</li>";
    return;
  } else {
    authEl.innerHTML = `<span>${ctx.profile?.display_name ?? "User"}</span>
                        <button id="logout">Sign out</button>`;
    document.getElementById("logout").onclick = api.signOut;
  }

  const BUCKET = "content";
  const userFolder = ctx.profile.display_name;
  const userName = (ctx.profile.display_name || "").trim().toLowerCase();

  // ----- Helpers -----
  async function listFiles(folder) {
    const names = new Set();
    let page = 0, pageSize = 100;
    while (true) {
      const { data, error } = await sb.supabase
        .storage.from(BUCKET)
        .list(folder, { limit: pageSize, offset: page * pageSize });
      if (error) {
        console.error("Storage list error:", error);
        break;
      }
      (data || []).forEach(f => names.add(f.name));
      if (!data || data.length < pageSize) break;
      page++;
    }
    return names;
  }

  async function markItemsByStorage(items, mdFolder, quizFolder) {
    const mdNames = await listFiles(mdFolder);
    const quizNames = await listFiles(quizFolder);

    return items.map(i => {
      const mdName = i.md_path?.split("/").pop();
      const qzName = i.quiz_path?.split("/").pop();

      const hasMd = mdNames.has(mdName);
      const hasQuiz = quizNames.has(qzName);

      return { ...i, hasMd, hasQuiz };
    });
  }

  // ----- Fetch -----
  async function fetchLessonsWithAttempts() {
    const lessons = await api.listLessonsWithAttempts(userName);
    console.log("Lessons fetched:", lessons);
    return lessons;
  }

  async function fetchTestsWithAttempts() {
    const tests = await api.listTestsWithAttempts(userName);
    console.log("Tests fetched:", tests);
    return tests;
  }

  // ----- Rendering -----
  function renderItems(items, containerEl, type, filterMode) {
    const filtered = items.filter(i => {
      const done = i.score != null; // true if attempted
      if (filterMode === "completed") return done;
      if (filterMode === "pending")   return !done;
      return true; // all
    });

    if (!filtered.length) {
      containerEl.innerHTML = `<li>No ${type} found.</li>`;
      return;
    }

    containerEl.innerHTML = filtered.map(i => {
      const done = i.score != null;
      const broken = !i.hasMd || !i.hasQuiz;
      let brokenTitle = "";
      if (broken) {
        if (!i.hasMd && !i.hasQuiz) brokenTitle = "Missing: Markdown and JSON";
        else if (!i.hasMd) brokenTitle = "Missing: Markdown (.md)";
        else if (!i.hasQuiz) brokenTitle = "Missing: JSON (.json)";
      }

      return `
        <li style="display:flex;align-items:center;justify-content:space-between;gap:1rem;margin:.25rem 0;">
          <span>
            <a href="${type.slice(0,-1)}.html?slug=${encodeURIComponent(i.slug)}">${i.title}</a>
            <small class="muted"> — for ${i.for_user ?? ""}</small>
            ${broken ? `<span style="color:orange;cursor:help;" title="${brokenTitle}">⚠️</span>` : ""}
          </span>
          <span style="display:flex;align-items:center;gap:.5rem;">
            ${done 
              ? `<span title="Completed">✅</span><span class="badge">${i.score}%</span>` 
              : `<span class="muted">Incomplete</span>`}
            ${broken 
              ? `<span class="muted">Unavailable</span>` 
              : `<a class="button" href="${type.slice(0,-1)}.html?slug=${encodeURIComponent(i.slug)}">Open</a>`}
          </span>
        </li>
      `;
    }).join("");
  }

  function renderProgressSummary(lessons, tests) {
    const doneLessons = lessons.filter(l => l.score != null).length;
    const totalLessons = lessons.length;
    const doneTests = tests.filter(t => t.score != null).length;
    const totalTests = tests.length;

    progressEl.innerHTML = `
      Lessons: ${doneLessons}/${totalLessons} completed |
      Tests: ${doneTests}/${totalTests} completed
    `;
  }

  // ----- Initial fetch -----
  let lessons = await fetchLessonsWithAttempts();
  lessons = await markItemsByStorage(
    lessons,
    `${userFolder}/lessons`,
    `${userFolder}/quizzes`
  );
  lessons.sort((a, b) => a.id - b.id); // sort by id

  let tests = await fetchTestsWithAttempts();
  tests = await markItemsByStorage(
    tests,
    `${userFolder}/tests`,
    `${userFolder}/tests/questions`
  );
  tests.sort((a, b) => a.id - b.id); // sort by id

  function doRender() {
    renderProgressSummary(lessons, tests);
    renderItems(lessons, lessonsEl, "lessons", filterEl.value);
    renderItems(tests, testsEl, "tests", filterEl.value);
  }

  // Restore filter from local storage
  filterEl.value = localStorage.getItem("lessonFilter") || "all";
  doRender();

  filterEl.addEventListener("change", () => {
    localStorage.setItem("lessonFilter", filterEl.value);
    doRender();
  });
})();
</script>
</body>
</html>
