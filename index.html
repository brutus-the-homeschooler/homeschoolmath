<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Math — Dashboard</title>
  <link rel="stylesheet" href="assets/app.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/supabaseClient.js"></script>
  <script src="assets/api.js"></script>
</head>
<body>
<header style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
  <h1>Math — Dashboard</h1>
  <div id="auth"></div>
</header>

<main id="content" class="card">
  <h2>Lessons</h2>
  <ul id="lessons">Loading…</ul>

  <h2>Tests</h2>
  <ul id="tests">Loading…</ul>
</main>

<p class="muted">Parent? Visit <a href="parent.html">Parent dashboard</a>.</p>

<script>
(async () => {
  const authEl    = document.getElementById('auth');
  const lessonsEl = document.getElementById('lessons');
  const testsEl   = document.getElementById('tests');

  // ----- Auth -----
  const ctx = await sb.currentUserWithProfile();
  if (!ctx) {
    // Restore login form
    authEl.innerHTML = `
      <input id="email" type="text" placeholder="Email" autocapitalize="none" autocomplete="username">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password">
      <button class="primary" id="login">Login</button>
    `;

    const doLogin = async () => {
      const btn = document.getElementById('login');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) { alert("Enter both email and password"); return; }
      btn.disabled = true;
      const user = await api.signInWithPassword(email, password);
      if (user) location.reload();
      btn.disabled = false;
    };

    document.getElementById('login').onclick = doLogin;
    document.getElementById('password').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') doLogin();
    });

    lessonsEl.innerHTML = '<li>Sign in to view lessons.</li>';
    testsEl.innerHTML   = '<li>Sign in to view tests.</li>';
    return;
  } else {
    authEl.innerHTML = `<span>${ctx.profile?.display_name ?? 'User'}</span>
                        <button id="logout">Sign out</button>`;
    document.getElementById('logout').onclick = api.signOut;
  }

  const BUCKET = 'content';
  const userFolder = ctx.profile.display_name;

  async function listAllNamesInFolder(bucket, folder) {
    const names = new Set();
    const pageSize = 100;
    let offset = 0;
    while (true) {
      const { data, error } = await sb.supabase
        .storage.from(bucket)
        .list(folder, { limit: pageSize, offset, sortBy: { column: 'name', order: 'asc' } });
      if (error) break;
      (data || []).forEach(entry => {
        if (entry.name) names.add(entry.name);
      });
      if (!data || data.length < pageSize) break;
      offset += pageSize;
    }
    return names;
  }

  // ----- Lessons -----
  const lessonFiles = await listAllNamesInFolder(BUCKET, `${userFolder}/lessons`);
  const quizFiles   = await listAllNamesInFolder(BUCKET, `${userFolder}/quizzes`);

  if (!lessonFiles.size) {
    lessonsEl.innerHTML = '<li>No lessons found.</li>';
  } else {
    lessonsEl.innerHTML = Array.from(lessonFiles).filter(f => f.endsWith('.md')).map(name => {
      const slug = name.replace('.md','');
      return `
        <li>
          <a href="lesson.html?slug=${encodeURIComponent(slug)}">${slug.replace(/-/g,' ')}</a>
        </li>
      `;
    }).join('');
  }

  // ----- Tests -----
  const testMdFiles   = await listAllNamesInFolder(BUCKET, `${userFolder}/tests`);
  const testQuizFiles = await listAllNamesInFolder(BUCKET, `${userFolder}/tests/questions`);

  const tests = Array.from(testMdFiles).filter(f => f.endsWith('.md')).filter(mdName => {
    const base = mdName.replace('.md','');
    return testQuizFiles.has(`${base}.json`);
  });

  if (!tests.length) {
    testsEl.innerHTML = '<li>No tests found.</li>';
  } else {
    testsEl.innerHTML = tests.map(name => {
      const slug = name.replace('.md','');
      return `
        <li>
          <a href="test.html?slug=${encodeURIComponent(slug)}">Test – ${slug.replace(/-/g,' ')}</a>
        </li>
      `;
    }).join('');
  }
})();
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Math — Dashboard</title>
  <link rel="stylesheet" href="assets/app.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/supabaseClient.js"></script>
  <script src="assets/api.js"></script>
</head>
<body>
<header style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
  <h1>Math — Dashboard</h1>
  <div id="auth"></div>
</header>

<main id="content" class="card">
  <h2>Lessons</h2>
  <ul id="lessons">Loading…</ul>

  <h2>Tests</h2>
  <ul id="tests">Loading…</ul>
</main>

<p class="muted">Parent? Visit <a href="parent.html">Parent dashboard</a>.</p>

<script>
(async () => {
  const authEl   = document.getElementById('auth');
  const lessonsEl = document.getElementById('lessons');
  const testsEl   = document.getElementById('tests');

  // ----- Auth -----
  const ctx = await sb.currentUserWithProfile();
  if (!ctx) {
    authEl.innerHTML = "Please log in.";
    return;
  } else {
    authEl.innerHTML = `<span>${ctx.profile?.display_name ?? 'User'}</span>
                        <button id="logout">Sign out</button>`;
    document.getElementById('logout').onclick = api.signOut;
  }

  const BUCKET = 'content';
  const userFolder = ctx.profile.display_name;

  async function listAllNamesInFolder(bucket, folder) {
    const names = new Set();
    const pageSize = 100;
    let offset = 0;
    while (true) {
      const { data, error } = await sb.supabase
        .storage.from(bucket)
        .list(folder, { limit: pageSize, offset, sortBy: { column: 'name', order: 'asc' } });
      if (error) break;
      (data || []).forEach(entry => {
        if (entry.name) names.add(entry.name);
      });
      if (!data || data.length < pageSize) break;
      offset += pageSize;
    }
    return names;
  }

  // ----- Lessons -----
  const lessonFiles = await listAllNamesInFolder(BUCKET, `${userFolder}/lessons`);
  const quizFiles   = await listAllNamesInFolder(BUCKET, `${userFolder}/quizzes`);

  if (!lessonFiles.size) {
    lessonsEl.innerHTML = '<li>No lessons found.</li>';
  } else {
    lessonsEl.innerHTML = Array.from(lessonFiles).filter(f => f.endsWith('.md')).map(name => {
      const slug = name.replace('.md','');
      return `
        <li>
          <a href="lesson.html?slug=${encodeURIComponent(slug)}">${slug.replace(/-/g,' ')}</a>
        </li>
      `;
    }).join('');
  }

  // ----- Tests -----
  const testMdFiles   = await listAllNamesInFolder(BUCKET, `${userFolder}/tests`);
  const testQuizFiles = await listAllNamesInFolder(BUCKET, `${userFolder}/tests/questions`);

  const tests = Array.from(testMdFiles).filter(f => f.endsWith('.md')).filter(mdName => {
    const base = mdName.replace('.md','');
    return testQuizFiles.has(`${base}.json`);
  });

  if (!tests.length) {
    testsEl.innerHTML = '<li>No tests found.</li>';
  } else {
    testsEl.innerHTML = tests.map(name => {
      const slug = name.replace('.md','');
      return `
        <li>
          <a href="test.html?slug=${encodeURIComponent(slug)}">Test – ${slug.replace(/-/g,' ')}</a>
        </li>
      `;
    }).join('');
  }
})();
</script>
</body>
</html>
